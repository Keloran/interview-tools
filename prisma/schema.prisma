// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               Int               @id @default(autoincrement())
  clerkId          String            @unique
  email            String            @unique
  name             String?
  calendarUuid     String            @unique @default(uuid())
  companies        Company[]
  applications     Application[]
  legacyInterviews LegacyInterview[]
}

model Company {
  id               Int               @id @default(autoincrement())
  name             String
  userId           Int
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  applications     Application[]
  legacyInterviews LegacyInterview[]
  created_at       DateTime          @default(now())

  @@unique([userId, name])
}

// LegacyInterview - the old interview table, kept for existing data
// Maps to the existing "Interview" table in the database
model LegacyInterview {
  id              Int               @id @default(autoincrement())
  companyId       Int
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  clientCompany   String?
  jobTitle        String
  applicationDate DateTime
  interviewer     String?
  stageId         Int
  stage           Stage             @relation(fields: [stageId], references: [id])
  stageMethodId   Int
  stageMethod     StageMethod       @relation(fields: [stageMethodId], references: [id])
  userId          Int
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  date            DateTime?
  deadline        DateTime?
  outcome         InterviewOutcome?
  notes           String?           @db.Text
  metadata        Json?
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt
  link            String?

  @@unique([userId, companyId, jobTitle, applicationDate, clientCompany])
  @@map("Interview") // Maps to existing Interview table
}

// Application represents a job application - the root entity for tracking
model Application {
  id              Int               @id @default(autoincrement())
  userId          Int
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId       Int
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  clientCompany   String?           // End client company (for recruitment agencies)
  jobTitle        String            // Role you're applying for
  applicationDate DateTime          // When you applied for this job
  jobPostingLink  String?           // URL of job posting
  interviews      Interview[]
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt

  @@unique([userId, companyId, jobTitle, applicationDate, clientCompany])
}

// Interview represents a single interview stage within an application
model Interview {
  id              Int               @id @default(autoincrement())
  applicationId   Int
  application     Application       @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  stageId         Int
  stage           Stage             @relation(fields: [stageId], references: [id])
  stageMethodId   Int
  stageMethod     StageMethod       @relation(fields: [stageMethodId], references: [id])
  interviewer     String?           // Name of person interviewing you
  date            DateTime?         // When this interview stage is scheduled
  deadline        DateTime?         // For take-home tests
  outcome         InterviewOutcome?
  notes           String?           @db.Text
  link            String?           // Meeting link (Teams, Google Meet, etc.)
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt

  // Parent-child for ordering within the application
  parentId        Int?
  parent          Interview?        @relation("InterviewChain", fields: [parentId], references: [id], onDelete: SetNull)
  children        Interview[]       @relation("InterviewChain")

  @@map("InterviewStage") // New table name to avoid conflict
}

model Stage {
  id               Int               @id @default(autoincrement())
  stage            String            @unique
  interviews       Interview[]
  legacyInterviews LegacyInterview[]
}

model StageMethod {
  id               Int               @id @default(autoincrement())
  method           String            @unique
  interviews       Interview[]
  legacyInterviews LegacyInterview[]
}

enum InterviewOutcome {
  SCHEDULED // Interview is scheduled
  PASSED // You progressed to next stage
  REJECTED // You didn't get through
  AWAITING_RESPONSE // Waiting to hear back
  OFFER_RECEIVED // You got the job offer!
  OFFER_ACCEPTED // You accepted the offer
  OFFER_DECLINED // You declined the offer
  WITHDREW // You withdrew your application
}
